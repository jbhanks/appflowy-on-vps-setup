---
- name: Install required packages
  dnf:
    name:
      - policycoreutils-python-utils
      - php-fpm
    state: present

- name: Restart Nginx
  service:
    name: nginx
    state: restarted

- name: Add deploy user to nginx group
  user:
    name: nginx
    groups: "{{ APPUSER }}"
    append: true

- name: Restrict home directory permissions
  file:
    path: "{{ '/home/' + APPUSER }}"
    mode: '0710'


- name: Deploy proxy_params
  copy:
    dest: /etc/nginx/proxy_params
    content: |
      proxy_set_header Host $http_host;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Proto $scheme;

- name: Backup existing nginx.conf
  command: mv /etc/nginx/nginx.conf /etc/nginx/nginx.conf.old
  args:
    creates: /etc/nginx/nginx.conf.old

- name: Write sitewide default nginx log format
  ansible.builtin.copy:
    dest: /etc/nginx/conf.d/00-log-formats.conf
    content: |
        log_format main
            '$remote_addr '
            '[$time_local] '
            '"$request_method $uri" '
            '$status '
            '$body_bytes_sent '
            'rt=$request_time '
            'urt=$upstream_response_time '
            'rid=$request_id '
            'proto=$server_protocol '
            'host=$host '
            'ua="$http_user_agent"';
  
- name: Deploy new nginx.conf
  ansible.builtin.copy:
    dest: /etc/nginx/nginx.conf
    content: |
      user nginx;
      worker_processes auto;
      pid /run/nginx.pid;

      # Load dynamic modules. See /usr/share/doc/nginx/README.dynamic.
      include /usr/share/nginx/modules/*.conf;

      events {
          worker_connections 64;
      }

      http {

          sendfile            on;
          tcp_nopush          on;
          tcp_nodelay         on;
          keepalive_timeout   65;
          types_hash_max_size 4096;
          include             /etc/nginx/mime.types;
          default_type        application/octet-stream;
          server_tokens off;

          # Load modular configuration files from the /etc/nginx/conf.d directory.
          include /etc/nginx/conf.d/*.conf;
          access_log  /var/log/nginx/access.log  main;
          error_log  /var/log/nginx/error.log warn;

          server {
              listen       80;
              listen       [::]:80;
              server_name  _;
              return 301 https://$host$request_uri;
              include /etc/nginx/default.d/*.conf;
              error_page 404 /404.html;
              location = /404.html {}
              error_page 500 502 503 504 /50x.html;
              location = /50x.html {}
          }
      }

- name: Reload Nginx
  service:
    name: nginx
    state: reloaded

- name: Clone test site repo using SSH key + askpass (no agent)
  ansible.builtin.shell: |
    set -euo pipefail
    SSH_ASKPASS_REQUIRE=force \
    SSH_ASKPASS="$HOME/.ssh/askpass.sh" \
    DISPLAY=:0 \
    GIT_SSH_COMMAND='ssh -i "$HOME/.ssh/ed25519_{{ DOMAIN }}" -o IdentitiesOnly=yes -o StrictHostKeyChecking=accept-new' \
      git clone {{ TEST_SITE_REPO }} /home/{{ APPUSER }}/bare-bones-site
  args:
    executable: /bin/bash
    creates: "/home/{{ APPUSER }}/bare-bones-site/.git"
  become: true
  become_user: "{{ APPUSER }}"
  environment:
    GITSSHPHRASE: "{{ GITSSHPHRASE }}"

- name: Generate hostnames
  set_fact:
    hostnames: >-
      {{ SUBDOMAINS | map('regex_replace', '^(.*)$', '\1.' + DOMAIN) | list }}

- name: Create web root directories
  file:
    path: "/var/www/html/{{ item }}"
    state: directory
    owner: "{{ APPUSER }}"
    group: nginx
    mode: '0755'
  loop: "{{ hostnames }}"

- name: Copy site content
  copy:
    src: "/home/{{ APPUSER }}/bare-bones-site/"
    dest: "/var/www/html/{{ item }}.{{ DOMAIN }}/"
    owner: "{{ APPUSER }}"
    group: nginx
    mode: '0755'
    remote_src: yes
  become: true
  loop: "{{ hostnames }}"

- name: Configure virtual host for hostnames
  copy:
    dest: "/etc/nginx/conf.d/{{ item }}.conf"
    content: |
      server {
          listen 80;
          listen [::]:80;
          server_name {{ item }}{{ ' www.'~item if item.count('.') == 1 else '' }};
          root /var/www/html/{{ item }};
      }
  loop: "{{ hostnames }}"

- name: Reload Nginx
  service:
    name: nginx
    state: reloaded

- name: Flush disk buffers
  shell: sync
  args:
    executable: /bin/bash

- name: Sleep briefly after sync
  pause:
    seconds: 5

# --- Actual reboot ---
- name: Reboot with generous timeouts
  reboot:
    connect_timeout: 30
    reboot_timeout: 900
    pre_reboot_delay: 0
    post_reboot_delay: 10
    test_command: whoami
